<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0">
<meta http-equiv="pragma" content="no-cache">

<style>
  div#resumo {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  pre {
    border: 1px solid #000;
    border-radius: 5px;
    padding: 8px;
  }
  pre img {
    display: block;
    margin-top: 8px;
  }
</style>
<body></body>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="module">
  import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js"
  import _0 from "./0.js"
  import diagrama from "./sintaxe/diagrama.js"

  fetch("./exemplos.md").then(e => e.text()).then(async e => {
    document.body.innerHTML = marked.parse(e)
    let total = 0
    let passaram = 0
    let falharam = 0
    let deram_erro = 0
    await Promise.all([...document.body.querySelectorAll("code")].map(async c => {
      total++
      const [código, expectativa] = c.textContent.split("\n---\n")
      let escopo
      let parte
      let caminho
      try {
        const depuração = await _0(código)
        escopo = depuração.escopo
        parte = depuração.parte
        caminho = depuração.caminho
      }
      catch (e) {
        deram_erro++
        const img = document.createElement("img")
        img.src = "https://img.shields.io/badge/erro-f00"
        c.parentElement.appendChild(img)
        console.error(e)
        return
      }
      if (parte === undefined) parte = ""
      if (caminho === undefined) caminho = ""
      if (parte !== código) {
        deram_erro++
        const caractere_erro = document.createElement("span")
        caractere_erro.style.backgroundColor = "#f00"
        caractere_erro.textContent = código.charAt(parte.length)
        c.innerHTML = parte + caractere_erro.outerHTML + c.textContent.slice(parte.length + 1)
        const img = document.createElement("img")
        img.style.marginBottom = "8px"
        img.src = "https://img.shields.io/badge/erro-f00"
        c.parentElement.appendChild(img)
        const avaliar_caminho = (caminho, indentação) => {
          if (Array.isArray(caminho)) {
            const juntar_textos = lista => {
              lista = lista.reduce((acc, curr) => {
                if (Array.isArray(curr)) curr = juntar_textos(curr)
                if (typeof curr !== 'string') {
                  acc.push(curr)
                  return acc
                }
                if (typeof acc[acc.length - 1] !== 'string') {
                  acc.push(curr)
                  return acc
                }
                acc[acc.length - 1] += curr
                return acc
              }, [])
              if (lista.length === 1 && typeof lista[0] === "string") return lista[0]
              return lista
            }
            caminho = juntar_textos(caminho)
            if (! Array.isArray(caminho)) return avaliar_caminho(caminho, indentação)
            return `${caminho.map(c => {
              if (Array.isArray(c)) return `${indentação}-\n${avaliar_caminho(c, `${indentação}  `)}`
              return avaliar_caminho(c, indentação)
            }).join("")}`
          }
          if (caminho.nome) {
            return `${indentação}-\n${indentação}  - $: ${caminho.nome}\n${avaliar_caminho([caminho.caminho_percorrido], `${indentação}  `)}`
          }
          if (typeof caminho === "string") {
            if (caminho === "\n") return `${indentação}- .: 000A\n`
            return `${indentação}- "${caminho.replace(/[^\\]?"/g, '\\"')}"\n`
          }
          throw new Error(JSON.stringify(caminho))
        }
        c.parentElement.appendChild(diagrama(jsyaml.load(`caminho:\n${avaliar_caminho([caminho], "  ")}`)))
        return
      }
      let retorno = escopo["#"]()
      if (Array.isArray(retorno)) {
        const arrays_iguais = (arr1, arr2) => {
          if (arr1.length !== arr2.length) return false;
          for (let i = 0; i < arr1.length; i++) {
            if (arr1[i] !== arr2[i]) return false;
          }
          return true;
        }
        if (arrays_iguais(retorno, JSON.parse(expectativa))) {
          passaram++
          const img = document.createElement("img")
          img.src = "https://img.shields.io/badge/passou-070"
          c.parentElement.appendChild(img)
          return
        }
      }
      if (`${retorno}\n` === expectativa) {
        passaram++
        const img = document.createElement("img")
        img.src = "https://img.shields.io/badge/passou-070"
        c.parentElement.appendChild(img)
        return
      }
      falharam++
      const img = document.createElement("img")
      img.style.marginBottom = "8px"
      img.src = "https://img.shields.io/badge/falhou-ff0"
      c.parentElement.appendChild(img)
      if (retorno === undefined) retorno = ""
      const div_retorno = document.createElement("div")
      div_retorno.textContent = "retorno\n  " + JSON.stringify(retorno)
      c.parentElement.appendChild(div_retorno)
      const div_escopo = document.createElement("div")
      div_escopo.textContent = "escopo\n" + Object.entries(escopo).map(e => {
        if (typeof e[1] === "function") return `  ${e[0]}() = ${JSON.stringify(e[1]())}\n`
        return `  ${e[0]} = ${JSON.stringify(e[1])}\n`
      }).join("")
      c.parentElement.appendChild(div_escopo)
    }))
    const div_resumo = document.createElement("div")
    div_resumo.style.position = "fixed"
    div_resumo.style.backgroundColor = "#fff"
    div_resumo.style.padding = "8px"
    div_resumo.style.borderRadius = "8px"
    div_resumo.style.top = "8px"
    div_resumo.style.right = "8px"
    div_resumo.id = "resumo"
    const div_total = document.createElement("div")
    const img_total = document.createElement("img")
    img_total.src = `https://img.shields.io/badge/total-${total}-000`
    div_total.appendChild(img_total)
    div_resumo.appendChild(div_total)
    if (passaram > 0) {
      const div_passaram = document.createElement("div")
      const img_passaram = document.createElement("img")
      img_passaram.src = `https://img.shields.io/badge/passaram-${passaram}_(${Math.round(passaram * 100 / total)}%25)-070`
      div_passaram.appendChild(img_passaram)
      div_resumo.appendChild(div_passaram)
    }
    if (falharam > 0) {
      const div_falharam = document.createElement("div")
      const img_falharam = document.createElement("img")
      img_falharam.src = `https://img.shields.io/badge/falharam-${falharam}_(${Math.round(falharam * 100 / total)}%25)-ff0`
      div_falharam.appendChild(img_falharam)
      div_resumo.appendChild(div_falharam)
    }
    if (deram_erro > 0) {
      const div_deram_erro = document.createElement("div")
      const img_deram_erro = document.createElement("img")
      img_deram_erro.src = `https://img.shields.io/badge/deram_erro-${deram_erro}_(${Math.round(deram_erro * 100 / total)}%25)-f00`
      div_deram_erro.appendChild(img_deram_erro)
      div_resumo.appendChild(div_deram_erro)
    }
    document.body.appendChild(div_resumo)
    document.body.style.marginTop = div_resumo.offsetHeight + 8
  })
</script>